quarkus:
  application:
    name: quarkus-message-service
  http:
    port: 8089
    host: 0.0.0.0  # Escuchar en todas las interfaces

  # Consul Service Discovery
  consul-config:
    enabled: true
    agent:
      host-port: ${CONSUL_HOST:localhost}:${CONSUL_PORT:8500}
      register: true
      service-name: ${quarkus.application.name}
      service-port: ${quarkus.http.port}
      service-host: ${SERVICE_HOST:localhost}  # IP pública o privada del EC2
      health-check-interval: 10s
      health-check-path: /q/health
      health-check-timeout: 5s
      # Tags para identificar el servicio
      service-tags: microservice,messages,quarkus,reactive

  smallrye-health:
    ui:
      enabled: true

  # PostgreSQL
  datasource:
    db-kind: postgresql
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
    # URL JDBC para Flyway
    jdbc:
      url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:erp_tlm_2021}
      max-size: 20
      min-size: 5
    # URL Reactiva para runtime
    reactive:
      url: postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:erp_tlm_2021}
      max-size: 20

  hibernate-orm:
    database:
      generation: none  # Flyway maneja las migraciones

  # Flyway - Ejecutar manualmente en deploy
  flyway:
    migrate-at-start: false
    baseline-on-migrate: true
    schemas: inbox_messages
    locations: db/migration
    table: flyway_schema_history

  # Swagger/OpenAPI - Activado en producción (puedes desactivar si lo prefieres)
  swagger-ui:
    always-include: true
    path: /swagger-ui

  # Redis Cache Configuration
  redis:
    hosts: ${REDIS_HOST:redis://localhost:6379}
    timeout: 10s
    max-pool-size: 20
    max-pool-waiting: 24
  cache:
    redis:
      expire-after-write: 30m
      prefix: "msg-svc"

  # Logging
  log:
    level: INFO
    category:
      "org.walrex": DEBUG
      "io.quarkus": INFO
    console:
      format: "%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n"

# Kafka Configuration
kafka:
  bootstrap:
    servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}

# MicroProfile Messaging (Kafka)
mp:
  messaging:
    connector:
      smallrye-kafka:
        apicurio:
          registry.url: ${SCHEMA_REGISTRY_URL:http://localhost:8081/apis/registry/v2}
    incoming:
      orders:
        connector: smallrye-kafka
        topic: order-events
        group.id: message-service-group
        auto.offset.reset: earliest
        enable.auto.commit: true
        value:
          deserializer: io.apicurio.registry.serde.avro.AvroKafkaDeserealizer
        apicurio:
          registry:
            avro-datum-provider: io.apicurio.registry.serde.avro.ReflectAvroDatumProvider
    outgoing:
      notifications:
        connector: smallrye-kafka
        topic: notification-events
        value:
          serializer: io.apicurio.registry.serde.avro.AvroKafkaSerializer
        apicurio:
          registry:
            auto-register: true